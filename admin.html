<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Writer Studio</title>
    <style>
        :root { --accent: #000; --bg: #f9f9f9; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; }
        
        /* 1. Login Gate */
        #gate { position: fixed; inset: 0; background: #fff; z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .gate-box { text-align: center; width: 100%; max-width: 300px; }
        
        /* 2. Admin Layout */
        #admin-ui { display: none; flex-direction: column; height: 100vh; }
        .nav { display: flex; background: #fff; border-bottom: 1px solid #ddd; padding: 0 10px; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-weight: bold; cursor: pointer; color: #888; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: #000; border-bottom-color: #000; }

        /* 3. Editor UI */
        .content-area { flex: 1; overflow-y: auto; padding: 20px; display: none; }
        .content-area.active { display: block; }
        
        /* Toolbar */
        .toolbar { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tool { padding: 8px 12px; background: #eee; border-radius: 6px; font-size: 14px; border: none; }

        /* Writing Zone */
        .editor-wrap { background: #fff; border-radius: 12px; border: 1px solid #ddd; overflow: hidden; }
        input.title-in { width: 100%; border: none; padding: 20px; font-size: 1.5rem; font-weight: bold; outline: none; border-bottom: 1px solid #eee; }
        #visual-editor { min-height: 300px; padding: 20px; outline: none; line-height: 1.6; }
        #html-editor { width: 100%; height: 300px; padding: 20px; border: none; font-family: monospace; display: none; outline: none; background: #222; color: #0f0; box-sizing: border-box; }

        /* Date & Publish */
        .meta-row { margin: 15px 0; display: flex; gap: 10px; }
        .meta-row input { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ddd; }
        .publish-btn { background: #000; color: #fff; width: 100%; padding: 20px; border: none; font-weight: bold; border-radius: 12px; margin-top: 10px; }
        
        /* Manage List */
        .post-card { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .logout-btn { background: none; border: 1px solid red; color: red; padding: 5px 10px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

    <div id="gate">
        <div class="gate-box">
            <h2>Keys, please.</h2>
            <input type="password" id="token" placeholder="Paste Token" style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;">
            <button onclick="unlock()" style="width:100%; padding:12px; background:#000; color:#fff; border-radius:8px; border:none; font-weight:bold;">Enter Admin</button>
        </div>
    </div>

    <div id="admin-ui">
        <div class="nav">
            <button class="tab-btn active" onclick="switchTab('write')">WRITE</button>
            <button class="tab-btn" onclick="switchTab('manage')">MANAGE</button>
            <button class="logout-btn" style="margin: 10px;" onclick="logout()">Logout</button>
        </div>

        <div id="tab-write" class="content-area active">
            <div class="toolbar">
                <button class="tool" onclick="exec('bold')">B</button>
                <button class="tool" onclick="exec('italic')">I</button>
                <button class="tool" onclick="exec('formatBlock','H1')">H1</button>
                <input type="color" onchange="exec('foreColor', this.value)" style="width:30px; height:30px; border:none; background:none;">
                <button class="tool" onclick="toggleMode()">View Code</button>
                <label class="tool">ðŸ“· <input type="file" style="display:none" onchange="handleMedia(this)"></label>
            </div>

            <div class="editor-wrap">
                <input type="text" id="post-title" class="title-in" placeholder="Entry Title">
                <div id="visual-editor" contenteditable="true" oninput="syncToCode()"></div>
                <textarea id="html-editor" oninput="syncToVisual()"></textarea>
            </div>

            <div class="meta-row">
                <input type="text" id="post-date" placeholder="Date (e.g. Feb 17, 2026)">
            </div>
            
            <button class="publish-btn" id="save-btn" onclick="savePost()">PUBLISH POST</button>
        </div>

        <div id="tab-manage" class="content-area">
            <div id="manage-list">Loading posts...</div>
        </div>
    </div>

<script>
    let currentToken = "";
    let isCodeView = false;
    let editingIndex = -1;
    const user = 'pablovolenski';
    const repo = 'my-blog';

    // 1. GATEKEEPER LOGIC
    function unlock() {
        currentToken = document.getElementById('token').value;
        if (!currentToken) return alert("No token!");
        document.getElementById('gate').style.display = 'none';
        document.getElementById('admin-ui').style.display = 'flex';
        document.getElementById('post-date').value = new Date().toDateString();
        loadManageList();
    }

    function logout() {
        location.reload(); // Wipes memory and shows login
    }

    // 2. TABS & EDITOR MODES
    function switchTab(t) {
        document.querySelectorAll('.content-area, .tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + t).classList.add('active');
        event.target.classList.add('active');
        if(t === 'manage') loadManageList();
    }

    function exec(cmd, val=null) { document.execCommand(cmd, false, val); syncToCode(); }

    function toggleMode() {
        const visual = document.getElementById('visual-editor');
        const code = document.getElementById('html-editor');
        isCodeView = !isCodeView;
        visual.style.display = isCodeView ? 'none' : 'block';
        code.style.display = isCodeView ? 'block' : 'none';
        event.target.innerText = isCodeView ? "View Visual" : "View Code";
    }

    function syncToCode() { document.getElementById('html-editor').value = document.getElementById('visual-editor').innerHTML; }
    function syncToVisual() { document.getElementById('visual-editor').innerHTML = document.getElementById('html-editor').value; }

    // 3. MEDIA & GITHUB LOGIC
    async function handleMedia(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = async (e) => {
            const b64 = e.target.result.split(',')[1];
            const name = `media/${Date.now()}-${file.name.replace(/\s/g,'-')}`;
            const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${name}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${currentToken}` },
                body: JSON.stringify({ message: "upload", content: b64 })
            });
            if(res.ok) {
                const url = `https://raw.githubusercontent.com/${user}/${repo}/main/${name}`;
                document.execCommand('insertHTML', false, `<img src="${url}" style="width:100%; border-radius:10px;">`);
            }
        };
        reader.readAsDataURL(file);
    }

    async function savePost() {
        const title = document.getElementById('post-title').value;
        const content = document.getElementById('visual-editor').innerHTML;
        const date = document.getElementById('post-date').value;
        const url = `https://api.github.com/repos/${user}/${repo}/contents/posts.json`;
        
        try {
            const res = await fetch(url + '?t=' + Date.now());
            const data = await res.json();
            let posts = JSON.parse(atob(data.content));

            const newPost = { title, content, date };
            if (editingIndex > -1) posts[editingIndex] = newPost;
            else posts.unshift(newPost);

            const update = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${currentToken}` },
                body: JSON.stringify({
                    message: "Update Blog",
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(posts, null, 2)))),
                    sha: data.sha
                })
            });

            if (update.ok) {
                alert("Success!");
                location.reload();
            }
        } catch (e) { alert("Error saving."); }
    }

    async function loadManageList() {
        const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/posts.json?t=` + Date.now());
        const data = await res.json();
        const posts = JSON.parse(atob(data.content));
        const list = document.getElementById('manage-list');
        list.innerHTML = "";
        posts.forEach((p, i) => {
            list.innerHTML += `<div class="post-card">
                <div><strong>${p.title}</strong><br><small>${p.date}</small></div>
                <div>
                    <button onclick="editPost(${i})">