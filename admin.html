<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Writer Studio</title>
    <style>
        :root { --accent: #000; --bg: #f9f9f9; --border: #ddd; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); height: 100vh; overflow: hidden; }
        
        /* 1. LOGIN GATE - Fixed Centering */
        #gate { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #fff; z-index: 2000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .gate-box { width: 90%; max-width: 320px; padding: 20px; text-align: center; }
        .gate-box h2 { margin-bottom: 20px; font-weight: 900; }
        .gate-box input { 
            width: 100%; padding: 15px; margin-bottom: 15px; 
            border: 2px solid #eee; border-radius: 10px; font-size: 16px; outline: none;
        }
        .gate-box input:focus { border-color: var(--accent); }
        .gate-box button { 
            width: 100%; padding: 15px; background: #000; color: #fff; 
            border: none; border-radius: 10px; font-weight: bold; font-size: 16px;
        }

        /* 2. ADMIN UI */
        #admin-ui { display: none; flex-direction: column; height: 100vh; }
        .nav { display: flex; background: #fff; border-bottom: 1px solid var(--border); align-items: center; padding: 0 10px; }
        .tab-btn { flex: 1; padding: 15px 0; border: none; background: none; font-weight: bold; color: #aaa; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: #000; border-bottom-color: #000; }
        .logout-btn { padding: 8px 12px; color: red; border: 1px solid red; border-radius: 6px; background: none; font-size: 11px; margin-left: 10px; }

        /* 3. EDITOR & TOOLS */
        .content-area { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .content-area.active { display: block; }
        
        .toolbar { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 10px; align-items: center; }
        .tool { padding: 10px 14px; background: #eee; border-radius: 8px; border: none; font-size: 14px; font-weight: bold; cursor: pointer; }
        
        .editor-wrap { background: #fff; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        input.title-in { width: 100%; border: none; padding: 20px; font-size: 1.5rem; font-weight: bold; outline: none; border-bottom: 1px solid #f4f4f4; }
        
        /* The Two Modes */
        #visual-editor { min-height: 350px; padding: 20px; outline: none; line-height: 1.6; background: #fff; }
        #html-editor { 
            width: 100%; min-height: 350px; padding: 20px; border: none; 
            font-family: 'Courier New', monospace; display: none; outline: none; 
            background: #1e1e1e; color: #9cdcfe; font-size: 14px;
        }

        .meta-row { margin-top: 15px; }
        .meta-row input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }

        .save-bar { padding: 15px; background: #fff; border-top: 1px solid var(--border); }
        .publish-btn { background: #000; color: #fff; width: 100%; padding: 18px; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; }

        /* List Management */
        .post-card { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .btn-group button { margin-left: 5px; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; background: #fff; }
    </style>
</head>
<body>

    <div id="gate">
        <div class="gate-box">
            <h2>Writer Studio</h2>
            <input type="password" id="tokenIn" placeholder="Enter GitHub Token">
            <button onclick="unlockApp()">Unlock Admin</button>
        </div>
    </div>

    <div id="admin-ui">
        <div class="nav">
            <button class="tab-btn active" id="btn-write" onclick="switchTab('write')">WRITE</button>
            <button class="tab-btn" id="btn-manage" onclick="switchTab('manage')">MANAGE</button>
            <button class="logout-btn" onclick="location.reload()">LOGOUT</button>
        </div>

        <div id="tab-write" class="content-area active">
            <div class="toolbar">
                <button class="tool" onclick="doEdit('bold')">B</button>
                <button class="tool" onclick="doEdit('italic')">I</button>
                <button class="tool" onclick="doEdit('formatBlock','h1')">H1</button>
                <input type="color" onchange="doEdit('foreColor', this.value)" style="width:30px; height:34px; border:none; background:none;">
                <button class="tool" onclick="toggleEditorMode()" id="mode-toggle">Code View</button>
                <label class="tool">ðŸ“· <input type="file" style="display:none" onchange="uploadImage(this)"></label>
            </div>

            <div class="editor-wrap">
                <input type="text" id="post-title" class="title-in" placeholder="Entry Title">
                <div id="visual-editor" contenteditable="true"></div>
                <textarea id="html-editor"></textarea>
            </div>

            <div class="meta-row">
                <input type="text" id="post-date" placeholder="Date (e.g., Feb 17, 2026)">
            </div>
            
            <div style="height: 20px;"></div>
            <button class="publish-btn" id="main-save-btn" onclick="publishContent()">PUBLISH POST</button>
        </div>

        <div id="tab-manage" class="content-area">
            <div id="manage-list">Loading...</div>
        </div>
    </div>

<script>
    let AUTH_TOKEN = "";
    let isCodeMode = false;
    let editIdx = -1;
    const G_USER = 'pablovolenski';
    const G_REPO = 'my-blog';

    // 1. APP CONTROL
    function unlockApp() {
        const val = document.getElementById('tokenIn').value;
        if (!val) { alert("Token required"); return; }
        AUTH_TOKEN = val;
        document.getElementById('gate').style.display = 'none';
        document.getElementById('admin-ui').style.display = 'flex';
        document.getElementById('post-date').value = new Date().toDateString();
    }

    function switchTab(t) {
        document.getElementById('tab-write').classList.remove('active');
        document.getElementById('tab-manage').classList.remove('active');
        document.getElementById('btn-write').classList.remove('active');
        document.getElementById('btn-manage').classList.remove('active');
        
        document.getElementById('tab-' + t).classList.add('active');
        document.getElementById('btn-' + t).classList.add('active');
        if(t === 'manage') refreshList();
    }

    // 2. EDITOR LOGIC
    function doEdit(cmd, val=null) {
        document.execCommand(cmd, false, val);
        updateCodeFromVisual();
    }

    function toggleEditorMode() {
        const v = document.getElementById('visual-editor');
        const c = document.getElementById('html-editor');
        isCodeMode = !isCodeMode;
        if (isCodeMode) {
            c.value = v.innerHTML;
            v.style.display = 'none';
            c.style.display = 'block';
            document.getElementById('mode-toggle').innerText = "Visual View";
        } else {
            v.innerHTML = c.value;
            c.style.display = 'none';
            v.style.display = 'block';
            document.getElementById('mode-toggle').innerText = "Code View";
        }
    }

    function updateCodeFromVisual() {
        document.getElementById('html-editor').value = document.getElementById('visual-editor').innerHTML;
    }

    // 3. API LOGIC
    async function uploadImage(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = async (e) => {
            const b64 = e.target.result.split(',')[1];
            const name = `media/${Date.now()}-${file.name.replace(/\s+/g,'-')}`;
            const res = await fetch(`https://api.github.com/repos/${G_USER}/${G_REPO}/contents/${name}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${AUTH_TOKEN}` },
                body: JSON.stringify({ message: "img upload", content: b64 })
            });
            if(res.ok) {
                const url = `https://raw.githubusercontent.com/${G_USER}/${G_REPO}/main/${name}`;
                document.execCommand('insertHTML', false, `<img src="${url}" style="width:100%; border-radius:10px; margin:10px 0;">`);
                updateCodeFromVisual();
            }
        };
        reader.readAsDataURL(file);
    }

    async function publishContent() {
        const title = document.getElementById('post-title').value;
        const content = isCodeMode ? document.getElementById('html-editor').value : document.getElementById('visual-editor').innerHTML;
        const date = document.getElementById('post-date').value;
        const url = `https://api.github.com/repos/${G_USER}/${G_REPO}/contents/posts.json`;

        if(!title || !content) { alert("Title and content needed"); return; }

        try {
            const res = await fetch(url + '?t=' + Date.now());
            const data = await res.json();
            let posts = JSON.parse(atob(data.content));

            if (editIdx > -1) posts[editIdx] = { title, content, date };
            else posts.unshift({ title, content, date });

            const update = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${AUTH_TOKEN}` },
                body: JSON.stringify({
                    message: "Web Studio Update",
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(posts, null, 2)))),
                    sha: data.sha
                })
            });

            if (update.ok) { alert("Success!"); location.reload(); }
        } catch (e) { alert("Error saving to GitHub."); }
    }

    async function refreshList() {
        const list = document.getElementById('manage-list');
        list.innerHTML = "Fetching...";
        try {
            const res = await fetch(`https://api.github.com/repos/${G_USER}/${G_REPO}/contents/posts.json?t=` + Date.now());
            const data = await res.json();
            const posts = JSON.parse(atob(data.content));
            list.innerHTML = "";
            posts.forEach((p, i) => {
                list.innerHTML += `<div class="post-card">
                    <div><strong>${p.title}</strong><br><small>${p.date}</small></div>
                    <div class="btn-group">
                        <button onclick="loadToEditor(${i})">Edit</button>
                        <button onclick="dropPost(${i})" style="color:red">Del</button>
                    </div>
                </div>`;
            });
        } catch(e) { list.innerHTML = "Error loading list."; }
    }

    window.loadToEditor = async function(idx) {
        const res = await fetch(`https://api.github.com/repos/${G_USER}/${G_REPO}/contents/posts.json`);
        const data = await res.json();
        const posts = JSON.parse(atob(data.content));
        const p = posts[idx];
        
        document.getElementById('post-title').value = p.title;
        document.getElementById('visual-editor').innerHTML = p.content;
        document.getElementById('html-editor').value = p.content;
        document.getElementById('post-date').value = p.date;
        editIdx = idx;
        document.getElementById('main-save-btn').innerText = "UPDATE EXISTING POST";
        switchTab('write');
    }

    window.dropPost = async function(idx) {
        if(!confirm("Delete forever?")) return;
        const url = `https://api.github.com/repos/${G_USER}/${G_REPO}/contents/posts.json`;
        const res = await fetch(url + '?t=' + Date.now());
        const data = await res.json();
        let posts = JSON.parse(atob(data.content));
        posts.splice(idx, 1);
        await fetch(url, {
            method: 'PUT',
            headers: { 'Authorization': `token ${AUTH_TOKEN}` },
            body: JSON.stringify({ message: "delete", content: btoa(JSON.stringify(posts, null, 2)), sha: data.sha })
        });
        refreshList();
    }
</script>
</body>
</html>