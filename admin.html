<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Admin</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; max-width: 500px; margin: 20px auto; padding: 20px; background: #f9f9f9; color: #333; }
        .box { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; font-size: 1.2rem; }
        input, textarea { width: 100%; margin-bottom: 15px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; /* Prevents iPhone zoom on focus */ }
        textarea { height: 150px; resize: vertical; }
        button { width: 100%; padding: 14px; background: #000; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
        button:active { opacity: 0.7; }
        .post-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .post-item:last-child { border-bottom: none; }
        .del-btn { width: auto; background: #ff4444; padding: 6px 12px; font-size: 0.8rem; }
        #status { text-align: center; color: #666; font-size: 0.9rem; margin-top: 10px; }
    </style>
</head>
<body>

<div class="box">
    <h2>New Post</h2>
    <input type="password" id="token" placeholder="GitHub Token (ghp_...)">
    <input type="text" id="title" placeholder="Post Title">
    <textarea id="content" placeholder="What's on your mind?"></textarea>
    <button onclick="updateBlog('add')">Publish to Blog</button>
    <div id="status"></div>
</div>

<div class="box">
    <h2>Manage Posts</h2>
    <button style="background:#666; margin-bottom:15px;" onclick="loadList()">Load/Refresh Posts</button>
    <div id="post-list"></div>
</div>

<script>
    const user = 'pablovolenski';
    const repo = 'my-blog';
    const path = 'posts.json';
    const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;

    function setStatus(msg) { document.getElementById('status').innerText = msg; }

    async function updateBlog(action, index = null) {
        const token = document.getElementById('token').value;
        if (!token) return alert("Please paste your GitHub Token first!");

        setStatus("Saving...");

        try {
            // 1. Get the current posts.json file from GitHub
            const res = await fetch(url + '?t=' + Date.now());
            const data = await res.json();
            let posts = JSON.parse(atob(data.content));

            if (action === 'add') {
                const title = document.getElementById('title').value;
                const content = document.getElementById('content').value;
                if (!title || !content) return alert("Title and Content are required!");
                
                posts.unshift({ title, content, date: new Date().toDateString() });
            } else if (action === 'delete') {
                if (!confirm("Are you sure you want to delete this post?")) { setStatus(""); return; }
                posts.splice(index, 1);
            }

            // 2. Convert updated list to Base64 and push back to GitHub
            const update = await fetch(url, {
                method: 'PUT',
                headers: { 
                    'Authorization': `token ${token}`, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({
                    message: action === 'add' ? `Add: ${document.getElementById('title').value}` : "Delete post",
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(posts, null, 2)))),
                    sha: data.sha
                })
            });

            if (update.ok) {
                setStatus("Done!");
                if (action === 'add') {
                    document.getElementById('title').value = '';
                    document.getElementById('content').value = '';
                }
                loadList();
            } else {
                setStatus("Error: " + update.status);
                alert("Upload failed. Check your token permissions (must have 'repo' access).");
            }
        } catch (e) { 
            setStatus("Error.");
            alert("Connection error: " + e.message); 
        }
    }

    async function loadList() {
        try {
            const res = await fetch(url + '?t=' + Date.now());
            const data = await res.json();
            const posts = JSON.parse(atob(data.content));
            const list = document.getElementById('post-list');
            list.innerHTML = '';
            
            posts.forEach((p, i) => {
                list.innerHTML += `
                    <div class="post-item">
                        <span style="font-weight:500;">${p.title}</span>
                        <button class="del-btn" onclick="updateBlog('delete', ${i})">Delete</button>
                    </div>`;
            });
        } catch (e) {
            alert("Could not load posts. Make sure posts.json exists.");
        }
    }
</script>

</body>
</html>