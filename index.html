<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - New Post</title>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 50px auto; padding: 20px; }
        input, textarea { width: 100%; margin-bottom: 10px; padding: 8px; box-sizing: border-box; }
        textarea { height: 150px; }
        button { width: 100%; padding: 10px; background: #333; color: #fff; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <h2>Create New Post</h2>
    <input type="password" id="token" placeholder="Paste GitHub Token here">
    <input type="text" id="title" placeholder="Post Title">
    <textarea id="content" placeholder="Post Content..."></textarea>
    <button onclick="publish()">Save Post</button>

    <script>
        async function publish() {
            const token = document.getElementById('token').value;
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const user = 'pablovolenski';
            const repo = 'my-blog';
            const path = 'posts.json';
            const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;

            try {
                // 1. Get the current file content
                const getRes = await fetch(url);
                const fileData = await getRes.json();
                const currentPosts = JSON.parse(atob(fileData.content));

                // 2. Add the new post to the top
                currentPosts.unshift({ title, content, date: new Date().toDateString() });

                // 3. Push the updated list back to GitHub
                const putRes = await fetch(url, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({
                        message: "New blog post",
                        content: btoa(JSON.stringify(currentPosts, null, 2)),
                        sha: fileData.sha
                    })
                });

                if (putRes.ok) {
                    alert("Success! Post added.");
                } else {
                    alert("Error: Check your token.");
                }
            } catch (err) {
                alert("Error: " + err.message);
            }
        }
    </script>
</body>
</html>